# Money Quiz Developer Documentation

## Table of Contents

1. [Architecture Overview](#architecture-overview)
2. [Getting Started](#getting-started)
3. [Core Concepts](#core-concepts)
4. [Working with Services](#working-with-services)
5. [Database Layer](#database-layer)
6. [Frontend Development](#frontend-development)
7. [Testing](#testing)
8. [Extending the Plugin](#extending-the-plugin)
9. [Best Practices](#best-practices)
10. [Troubleshooting](#troubleshooting)

## Architecture Overview

The Money Quiz plugin follows modern PHP development practices with a layered architecture:

```
┌─────────────────────────────────────────────────────┐
│                    Presentation Layer                │
│                 (Controllers, Views, API)            │
├─────────────────────────────────────────────────────┤
│                    Service Layer                     │
│              (Business Logic, Validation)            │
├─────────────────────────────────────────────────────┤
│                  Repository Layer                    │
│               (Data Access Abstraction)              │
├─────────────────────────────────────────────────────┤
│                   Database Layer                     │
│                  (Models, Migrations)                │
└─────────────────────────────────────────────────────┘
```

### Key Design Patterns

- **Dependency Injection**: All dependencies are injected via constructor
- **Repository Pattern**: Database queries abstracted into repositories
- **Service Layer**: Business logic separated from data access
- **Singleton Pattern**: Used sparingly for global plugin instance
- **Observer Pattern**: WordPress hooks for extensibility

## Getting Started

### Development Setup

```bash
# Clone repository
git clone https://github.com/businessinsights/money-quiz.git
cd money-quiz

# Install PHP dependencies
composer install

# Install Node dependencies (for asset building)
npm install

# Set up local WordPress environment
wp env start

# Run tests
composer test

# Build assets
npm run build
```

### Local Development

1. **Using wp-env** (Recommended):
```bash
npm install -g @wordpress/env
wp-env start
```

2. **Using Local by Flywheel**:
   - Create new site
   - Clone plugin to `/app/public/wp-content/plugins/`
   - Activate plugin

3. **Using XAMPP/MAMP**:
   - Set up WordPress locally
   - Symlink plugin directory

## Core Concepts

### Container (Dependency Injection)

The plugin uses a simple but powerful DI container:

```php
// Getting services from container
$container = Plugin::get_instance()->get_container();
$quiz_service = $container->get('quiz_service');

// Binding services
$container->bind('my_service', function($container) {
    return new MyService(
        $container->get('dependency1'),
        $container->get('dependency2')
    );
});

// Singleton binding
$container->bind('singleton_service', function() {
    return new SingletonService();
}, true);
```

### Service Layer

Services contain business logic and coordinate between repositories:

```php
namespace MoneyQuiz\Services;

class QuizService {
    private QuizRepository $quiz_repository;
    private ResultRepository $result_repository;
    
    public function __construct(
        QuizRepository $quiz_repository,
        ResultRepository $result_repository
    ) {
        $this->quiz_repository = $quiz_repository;
        $this->result_repository = $result_repository;
    }
    
    public function submit_quiz(int $quiz_id, array $answers): Result {
        // Validate quiz exists
        $quiz = $this->quiz_repository->find($quiz_id);
        if (!$quiz) {
            throw new QuizNotFoundException();
        }
        
        // Calculate results
        $scores = $this->calculate_scores($quiz, $answers);
        
        // Save result
        return $this->result_repository->create([
            'quiz_id' => $quiz_id,
            'scores' => $scores,
            'answers' => $answers
        ]);
    }
}
```

### Repository Pattern

Repositories handle data access:

```php
namespace MoneyQuiz\Repositories;

class QuizRepository extends BaseRepository {
    protected string $table = 'money_quiz_quizzes';
    
    public function find_by_slug(string $slug): ?Quiz {
        $data = $this->db->get_row($this->db->prepare(
            "SELECT * FROM {$this->get_table()} WHERE slug = %s",
            $slug
        ));
        
        return $data ? $this->hydrate($data) : null;
    }
    
    public function get_active_quizzes(): array {
        $results = $this->db->get_results(
            "SELECT * FROM {$this->get_table()} 
             WHERE is_active = 1 
             ORDER BY sort_order ASC"
        );
        
        return array_map([$this, 'hydrate'], $results);
    }
}
```

## Working with Services

### Available Services

1. **QuizService**: Main quiz operations
2. **ArchetypeService**: Archetype calculations
3. **EmailService**: Email notifications
4. **CacheService**: Caching operations
5. **SecurityService**: Security utilities

### Creating New Services

```php
// 1. Create service class
namespace MoneyQuiz\Services;

class MyNewService {
    private DependencyService $dependency;
    
    public function __construct(DependencyService $dependency) {
        $this->dependency = $dependency;
    }
    
    public function do_something(): void {
        // Implementation
    }
}

// 2. Register in Plugin.php
private function register_services(): void {
    $this->container->bind('my_new_service', function($container) {
        return new MyNewService(
            $container->get('dependency_service')
        );
    });
}

// 3. Use the service
$service = Plugin::get_instance()->get_container()->get('my_new_service');
$service->do_something();
```

## Database Layer

### Schema

The plugin uses custom tables for optimal performance:

```sql
-- Main tables
money_quiz_quizzes       -- Quiz definitions
money_quiz_questions     -- Questions bank
money_quiz_archetypes    -- Archetype definitions
money_quiz_results       -- User results
money_quiz_answers       -- Individual answers
money_quiz_settings      -- Configuration
```

### Migrations

Create new migrations in `/src/Database/Migrations/`:

```php
namespace MoneyQuiz\Database\Migrations;

class AddCustomFieldMigration implements MigrationInterface {
    public function up(): void {
        global $wpdb;
        
        $wpdb->query("
            ALTER TABLE {$wpdb->prefix}money_quiz_quizzes 
            ADD COLUMN custom_field VARCHAR(255) DEFAULT NULL
        ");
    }
    
    public function down(): void {
        global $wpdb;
        
        $wpdb->query("
            ALTER TABLE {$wpdb->prefix}money_quiz_quizzes 
            DROP COLUMN custom_field
        ");
    }
}
```

### Working with Models

```php
// Creating records
$quiz = new Quiz([
    'title' => 'My Quiz',
    'slug' => 'my-quiz',
    'description' => 'Quiz description'
]);
$quiz->save();

// Finding records
$quiz = Quiz::find(1);
$quiz = Quiz::where('slug', 'my-quiz')->first();

// Updating
$quiz->title = 'Updated Title';
$quiz->save();

// Relationships
$questions = $quiz->questions()->get();
$archetype = $result->dominant_archetype();
```

## Frontend Development

### JavaScript Architecture

The frontend uses jQuery with a modular approach:

```javascript
// Main quiz controller
var MoneyQuiz = {
    init: function() {
        this.bindEvents();
        this.loadQuiz();
    },
    
    bindEvents: function() {
        $(document).on('click', '.quiz-next', this.nextQuestion.bind(this));
        $(document).on('money-quiz-loaded', this.onQuizLoaded.bind(this));
    }
};

// Extensions
MoneyQuiz.Analytics = {
    track: function(event, data) {
        // Analytics implementation
    }
};
```

### CSS Architecture

Using BEM methodology with CSS custom properties:

```css
/* Base component */
.money-quiz {
    --mq-primary: #007cba;
    --mq-spacing: 1rem;
}

/* Element */
.money-quiz__question {
    margin-bottom: var(--mq-spacing);
}

/* Modifier */
.money-quiz__question--active {
    display: block;
}

/* State */
.money-quiz.is-loading {
    opacity: 0.5;
}
```

### AJAX Endpoints

```javascript
// Submit quiz
$.ajax({
    url: money_quiz_ajax.ajax_url,
    type: 'POST',
    data: {
        action: 'money_quiz_submit',
        nonce: money_quiz_ajax.nonce,
        quiz_id: quizId,
        answers: answers
    },
    success: function(response) {
        if (response.success) {
            // Handle success
        }
    }
});
```

## Testing

### Unit Tests

```php
use PHPUnit\Framework\TestCase;
use MoneyQuiz\Services\QuizService;

class QuizServiceTest extends TestCase {
    private QuizService $service;
    
    protected function setUp(): void {
        parent::setUp();
        
        $this->service = new QuizService(
            $this->createMock(QuizRepository::class),
            $this->createMock(ResultRepository::class)
        );
    }
    
    public function test_calculate_scores() {
        $quiz = $this->create_test_quiz();
        $answers = ['q1' => 'a1', 'q2' => 'a2'];
        
        $scores = $this->service->calculate_scores($quiz, $answers);
        
        $this->assertArrayHasKey('archetype1', $scores);
        $this->assertGreaterThan(0, $scores['archetype1']);
    }
}
```

### Integration Tests

```php
class QuizIntegrationTest extends WP_UnitTestCase {
    public function test_complete_quiz_flow() {
        // Create quiz
        $quiz_id = $this->factory->quiz->create();
        
        // Submit answers
        $result = do_action('money_quiz_submit', $quiz_id, [
            'q1' => 'answer1',
            'q2' => 'answer2'
        ]);
        
        // Verify result
        $this->assertInstanceOf(Result::class, $result);
        $this->assertEquals($quiz_id, $result->quiz_id);
    }
}
```

### Running Tests

```bash
# All tests
composer test

# Specific test suite
composer test -- --testsuite=unit

# Single test file
composer test tests/Unit/QuizServiceTest.php

# With coverage
composer test -- --coverage-html coverage/
```

## Extending the Plugin

### Adding Custom Archetypes

```php
// Filter to modify archetypes
add_filter('money_quiz_archetypes', function($archetypes) {
    $archetypes[] = [
        'id' => 'custom',
        'name' => 'Custom Archetype',
        'description' => 'Description',
        'traits' => ['trait1', 'trait2']
    ];
    
    return $archetypes;
});
```

### Custom Question Types

```php
// Register new question type
add_filter('money_quiz_question_types', function($types) {
    $types['slider'] = [
        'label' => 'Slider Question',
        'renderer' => 'render_slider_question',
        'validator' => 'validate_slider_answer'
    ];
    
    return $types;
});

// Renderer
function render_slider_question($question) {
    ?>
    <div class="slider-question">
        <input type="range" 
               name="question_<?php echo $question->id; ?>"
               min="0" max="100" />
    </div>
    <?php
}
```

### Custom Scoring Algorithms

```php
// Override scoring calculation
add_filter('money_quiz_calculate_scores', function($scores, $quiz, $answers) {
    // Custom scoring logic
    foreach ($answers as $question_id => $answer) {
        // Apply custom weights
        $scores = apply_custom_scoring($scores, $question_id, $answer);
    }
    
    return $scores;
}, 10, 3);
```

## Best Practices

### Security

1. **Always validate input**:
```php
$quiz_id = absint($_POST['quiz_id'] ?? 0);
$email = sanitize_email($_POST['email'] ?? '');
```

2. **Use nonces**:
```php
if (!wp_verify_nonce($_POST['nonce'], 'money_quiz_action')) {
    wp_die('Security check failed');
}
```

3. **Capability checks**:
```php
if (!current_user_can('manage_money_quiz')) {
    wp_die('Unauthorized');
}
```

### Performance

1. **Cache expensive operations**:
```php
$cache_key = 'money_quiz_results_' . $user_id;
$results = wp_cache_get($cache_key);

if (false === $results) {
    $results = $this->calculate_results($user_id);
    wp_cache_set($cache_key, $results, '', HOUR_IN_SECONDS);
}
```

2. **Use database indexes**:
```sql
CREATE INDEX idx_quiz_active ON money_quiz_quizzes(is_active, sort_order);
CREATE INDEX idx_result_user ON money_quiz_results(user_email, created_at);
```

3. **Lazy load when appropriate**:
```php
// Only load questions when needed
public function get_questions() {
    if (null === $this->questions) {
        $this->questions = $this->load_questions();
    }
    return $this->questions;
}
```

### Code Style

Follow PSR-12 coding standards:

```php
namespace MoneyQuiz\Services;

use MoneyQuiz\Models\Quiz;
use MoneyQuiz\Repositories\QuizRepository;

class QuizService
{
    private QuizRepository $repository;
    
    public function __construct(QuizRepository $repository)
    {
        $this->repository = $repository;
    }
    
    public function findActive(): array
    {
        return $this->repository->whereActive(true)
            ->orderBy('sort_order')
            ->get();
    }
}
```

## Troubleshooting

### Common Issues

1. **Class not found errors**:
   - Run `composer dump-autoload`
   - Check namespace and file path match
   - Verify PSR-4 configuration

2. **Database errors**:
   - Check table prefix
   - Verify migrations ran
   - Enable `WP_DEBUG` for details

3. **JavaScript not loading**:
   - Check console for errors
   - Verify script dependencies
   - Check for conflicts

### Debugging

```php
// Enable debug logging
define('WP_DEBUG', true);
define('WP_DEBUG_LOG', true);
define('WP_DEBUG_DISPLAY', false);
define('MONEY_QUIZ_DEBUG', true);

// Debug helper
function mq_debug($data, $label = '') {
    if (defined('MONEY_QUIZ_DEBUG') && MONEY_QUIZ_DEBUG) {
        error_log($label . ': ' . print_r($data, true));
    }
}

// Usage
mq_debug($quiz_data, 'Quiz Data');
```

### Performance Profiling

```php
// Simple profiler
$start = microtime(true);

// Code to profile
$results = $this->expensive_operation();

$duration = microtime(true) - $start;
mq_debug($duration, 'Operation took (seconds)');
```

---

For more information or questions about development:
- Email: andre@101BusinessInsights.info
- GitHub: [Issues](https://github.com/businessinsights/money-quiz/issues)
- Slack: #money-quiz-dev